# Obsidian Whisper Transcribe - 仕様書

## 概要

Whisper APIを使用して音声を録音し、文字起こしを行うObsidianプラグイン。

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 0.1.0 | 2026-02-10 | 初期仕様策定 |

---

## 1. プラグイン基本情報

- **プラグイン名**: Whisper Transcribe
- **プラグインID**: whisper-transcribe
- **対応プラットフォーム**: Desktop / Mobile（iOS, Android）
- **最小Obsidianバージョン**: 1.0.0

---

## 2. 設定項目

### 2.1 API設定

| 設定項目 | 型 | デフォルト値 | 説明 |
|---------|-----|-------------|------|
| apiKey | string | "" | OpenAI API Key（プレーンテキスト保存） |
| apiUrl | string | "https://api.openai.com/v1/audio/transcriptions" | API エンドポイントURL |
| model | string | "whisper-1" | 使用モデル（whisper-1, gpt-4o-mini-transcribe等） |
| language | string | "ja" | 文字起こし言語（ja, en等） |
| timeout | number | 300000 | APIタイムアウト（ミリ秒）、デフォルト5分 |
| temperature | number | 0 | 文字起こしの温度パラメータ（0-1） |
| initialPrompt | string | "" | カスタムプロンプト（用語集・文脈指定用） |

### 2.2 保存設定

| 設定項目 | 型 | デフォルト値 | 説明 |
|---------|-----|-------------|------|
| audioFolder | string | "recordings" | 音声ファイル保存フォルダ |
| transcriptFolder | string | "transcripts" | 文字起こしファイル保存フォルダ |

### 2.3 トリミング設定

| 設定項目 | 型 | デフォルト値 | 説明 |
|---------|-----|-------------|------|
| enableTrimming | boolean | true | トリミング機能を有効化 |
| autoSkipDuration | number | 20 | この秒数以下はトリミング画面をスキップ |
| defaultThresholdDb | number | -40 | 無音閾値のデフォルト値（dB） |
| minSilenceDuration | number | 0.6 | 無音と判定する最小秒数 |
| silenceMargin | number | 0.2 | 音声前後の保護マージン（秒） |

### 2.4 その他

| 設定項目 | 型 | デフォルト値 | 説明 |
|---------|-----|-------------|------|
| chunkSizeMB | number | 20 | 分割送信時のチャンクサイズ（MB） |

---

## 3. 録音機能

### 3.1 基本仕様

- **形式**: WebM/Opus (.webm)
- **サンプルレート**: 16kHz
- **チャンネル**: モノラル
- **最大録音時間**: 24時間
- **同時録音数**: 1（API送信中に新規録音開始は可能）

### 3.2 録音フロー

1. コマンドパレットまたはリボンアイコンから録音モーダルを開く
2. 「録音開始」ボタンをクリックして録音開始
3. 録音中は以下を表示:
   - 経過時間
   - 音量レベルメーター
4. 一時停止/再開が可能
5. 「録音停止」で録音終了
6. 録音停止後、トリミング編集画面を表示（20秒超の場合）
7. 「送信」ボタンでAPI送信確認
8. 「キャンセル」で録音破棄

### 3.3 モーダルUI

- **サイズ**: 固定サイズ
- **一時停止表示**: アイコン変更
- **モーダル外クリック**: モーダルを裏に移動、録音は継続
- **バックグラウンド録音**: Obsidianがフォーカスを失っても継続
- **モバイル**: バックグラウンドでも継続録音

### 3.4 マイク

- デフォルトマイクを使用
- マイク権限がない場合はガイダンス表示

---

## 4. API送信機能

### 4.1 基本仕様

- **API形式**: OpenAI Whisper API互換
- **レスポンス形式**: json（タイムスタンプなし）
- **セグメント単位**: segment単位のみ（word単位なし）

### 4.2 チャンク送信

- 25MB以上のファイルはサイズベースで分割（デフォルト20MBごと）
- 分割結果は1つのページにマージ

### 4.3 進捗表示

- 「アップロード: 45% (12MB/27MB)」形式で表示
- キャンセル不可

### 4.4 エラーハンドリング

- オフライン時: 録音のみ保存
- API失敗時: 音声ファイルを保持、後で手動再送信可能

### 4.5 再送信機能

- 音声ファイルを右クリック→コマンドで再送信
- 既存の文字起こしがあっても新規ページ作成

---

## 5. 文字起こし結果ページ

### 5.1 ファイル名形式

```
YYYY-MM-DD_HHmmss_transcription.md
```

同一秒に複数作成時は連番付与:
```
2026-02-10_143052_transcription.md
2026-02-10_143052_transcription_1.md
```

### 5.2 フロントマター

```yaml
---
date: 2026-02-10T14:30:52+09:00
language: ja
model: whisper-1
duration: 125.4
audio_file: "[[recordings/2026-02-10_143052.webm]]"
tags:
  - transcription
---
```

### 5.3 本文形式

```markdown
[00:00:00](recordings/2026-02-10_143052.webm) こんにちは、今日は...
[00:01:30](recordings/2026-02-10_143052.webm) 次のトピックについて...
```

- タイムスタンプはObsidianネイティブ機能でのジャンプを想定（現状は表示のみ、将来対応）
- セグメント区切りは改行のみ
- 音声ファイルへのリンク: `[[audio.webm]]`形式（埋め込みではない）

---

## 6. ステータスバー

- 録音中: 状態表示（🔴 Recording 00:05:23）
- API送信中: 進捗表示

---

## 7. 通知

- Obsidianネイティブ通知を使用
- エラーログはコンソール出力

---

## 8. 国際化（i18n）

- Obsidianの言語設定に追従
- デフォルト言語: 英語（en）
- 対応言語: 英語（en）、日本語（ja）
- 翻訳ファイル形式: JSON

---

## 9. 設定のインポート/エクスポート

- 設定をJSON形式でエクスポート可能
- JSONファイルからインポート可能

---

## 10. 接続テスト

- 設定画面に「接続テスト」ボタン
- API接続の疎通確認

---

## 11. コマンド

| コマンドID | 名前（en） | 名前（ja） | 説明 |
|-----------|-----------|-----------|------|
| open-recorder | Open Recorder | 録音を開く | 録音モーダルを開く |
| transcribe-audio-file | Transcribe Audio File | 音声ファイルを文字起こし | 選択した音声ファイルをAPIに送信 |

---

## 12. ファイルコンテキストメニュー

- 音声ファイル（.webm, .mp3, .wav, .m4a）を右クリック時に「文字起こし」コマンドを表示

---

## 13. GitHub Actions CI/CD

- プルリクエスト時: lint, test, build
- タグプッシュ時: リリース作成
